#' Create processing environment
#'
#' This function creates and returns an new environment to store all user-set variables with the option to save as an RDS file for easy reading-in to a future session.
#' @param base.dir character; path to working directory. It is helpful to make this explicit (rather than using '.') for generating SGE_Array commands.
#' @param raw.seq.dir character; path to raw FASTQs directory.
#' @param interactive logical; TRUE = run command interactively, no swarm computing possible, FALSE = generate SGE_Batch or SGE_Array commands to submit manually. Default is FALSE
#' @param job.queue character; the queue to that jobs will be sent to, for generating SGE commands. Default is NULL.
#' @param jobs.dir character; path to write command files to for submission to the scheduler from the appropriate machine, e.g., "/home/micro/stagamak/Jobs". Default is ".".
#' @param max.cores integer; maximum cores to take advantage of (when utilizing swarm processing this number will be divided by max.concurrent jobs to determine the per-job number of cores). Default is 1.
#' @param max.concurrent.jobs integer; maximum concurrent jobs to run. If `interactive` == TRUE, this will be forced to 1. Default is 1.
#' @param link.dir character; path to directory wherein you want to make symlinks to raw FASTQs. If set to NULL, will use the `base.dir`. Default is NULL.
#' @param store.dir character; path to directory where all output will be stored. If set to NULL, will use the `base.dir`. Default is NULL.
#' @param temp.dir character; path to a directory where output will first be written before moving to the permanent output directory, if NULL, output is written directly to `store.dir`. Default is NULL.
#' @param max.memory character; maximum memory to set for jobs submitted to SGE_Batch or SGE_Array. Must take the form of e.g. "10G" or "50G" Setting to NULL means this parameter is not specified in the command. Default is NULL.
#' @param qsub.options character; further qsub arguments you want included in the SGE_Batch or SGE_Array commands, e.g., get email at end of job with "'-m ae -M yourname@example.com'". This argument must be in double and single quotes like example to be parsed correctly. Setting to NULL means this parameter i snot specified in the command. Default is NULL.
#' @param save.env.dir character; if not NULL, will create and this save this enviroment in the provided directory with the date and time of creation in the file name. Default is NULL.
#' @param ... additional variables you want to set here
#' @seealso \code{\link{system}}, \code{\link{generate.tool.command}}
#' @export


create.processing.env <- function(
    base.dir,
    raw.seq.dir,
    interactive = FALSE,
    job.queue = NULL,
    jobs.dir = ".",
    max.cores = 1,
    max.concurrent.jobs = 1,
    link.dir = NULL,
    store.dir = NULL,
    temp.dir = NULL,
    max.memory = NULL,
    qsub.options = NULL,
    save.env.dir = NULL
) {
  require(magrittr)
  require(stringr)
  vars <- as.list(rlang::call_match(defaults = TRUE))[-1]
  newEnv <- new.env()
  for (i in seq_along(vars)) {
    assign(x = names(vars)[i], value = vars[[i]], envir = newEnv)
  }
  if (!is.null(save.env.dir)) {
    if (!dir.exists(save.env.dir)) {
      rlang::abort(
        "Argument `save.env.dir' is supplied, but doesn't exist. Please create the directory and re-run."
        )
    }
    date.time <- Sys.time() %>%
      str_replace_all(" ", "_") %>%
      str_replace_all(":", "-")
    saveRDS(
      newEnv,
      file = file.path(
        save.env.dir,
        paste0("metaGTx_processing_environment_", date.time, ".rds")
        )
      )
  }
  return(newEnv)
}
